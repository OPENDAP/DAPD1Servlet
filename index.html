<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Dapd1servlet by jgallagher59701</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Dapd1servlet</h1>
        <p>DAP-DataONE Servlet. This implements a DataONE Version 1, tier 1, Member Node for data accessible using DAP2</p>

        <p class="view"><a href="https://github.com/jgallagher59701/DAPD1Servlet">View the Project on GitHub <small>jgallagher59701/DAPD1Servlet</small></a></p>


        <ul>
          <li><a href="https://github.com/jgallagher59701/DAPD1Servlet/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/jgallagher59701/DAPD1Servlet/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/jgallagher59701/DAPD1Servlet">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="welcome-to-the-dap-dataone-server-documentation" class="anchor" href="#welcome-to-the-dap-dataone-server-documentation"><span class="octicon octicon-link"></span></a>Welcome to the DAP-DataONE server documentation</h1>

<p>The DAP-DataONE server is an implementation of a DataONE version 1, tier 1 Member Node. It is designed to act as a kind of broker for DataONE clients and data served using OPeNDAP. The initial version of the server only supports DAP2 but will work with any DAP server that can return data packaged in netCDF3 files and can return ISO-19115 metadata documents for those datasets. The server is implemented as a Java Servlet that contains the implementation of the DataONE Member Node protocol and a simple database paired with a command-line tool to add or update datasets in the database. The database uses SQLite, although all of the software interacts with it using JDBC, so a different RDB could be used with only very trivial modifications to the software.</p>

<h2>
<a name="whats-here-in-the-documentation" class="anchor" href="#whats-here-in-the-documentation"><span class="octicon octicon-link"></span></a>What's here in the documentation?</h2>

<p>The documentation contains information about how to:</p>

<ul>
<li>Build the software from source</li>
<li>Test the software using a preconfigured database</li>
<li>Serving your own data</li>
</ul><p>In addition, there is documentation that discusses ways the server could be made more powerful and limitations imposed by the designs of DAP2 and DataONE:</p>

<ul>
<li>How it works</li>
<li>Optimizations and Improvements</li>
<li>Limitations</li>
</ul><h2>
<a name="beta-software-what-we-assume" class="anchor" href="#beta-software-what-we-assume"><span class="octicon octicon-link"></span></a>Beta software; What we assume</h2>

<p>This is beta software without a polished build/install process. We assume you are computer savvy and know how to configure systems, install software, start and stop web servers, ... all that stuff. If you want to use this software but are unfamiliar with these kinds of things, contact us at <a href="mailto:support@opendap.org">support@opendap.org</a> or <a href="https://www.dataone.org/contact">DataONE:Contact</a>.</p>

<h2>
<a name="build-the-software" class="anchor" href="#build-the-software"><span class="octicon octicon-link"></span></a>Build the software</h2>

<p>This project and its companion, DAPD1DatasetsDatabase, use Maven. </p>

<h3>
<a name="get-maven-if-you-do-not-already-have-it" class="anchor" href="#get-maven-if-you-do-not-already-have-it"><span class="octicon octicon-link"></span></a>Get Maven if you do not already have it</h3>

<p>Goto <a href="http://maven.apache.org/download.cgi">http://maven.apache.org/download.cgi</a>, get the binary and install it. On a Mac OSX machine, put the <code>apache-maven-&lt;ver&gt;</code> directory in <code>/Applications</code>. Then add</p>

<ul>
<li>export M2_HOME=/Applications/apache-maven-3.1.1</li>
<li>export PATH=$PATH:$M2_HOME/bin
to <code>.bashrc</code> or the equivalent. <code>mvn --version</code> should work and return the expected info. </li>
</ul><h3>
<a name="build-the-code" class="anchor" href="#build-the-code"><span class="octicon octicon-link"></span></a>Build the code</h3>

<p>Use git to <code>clone</code> the <a href="https://github.com/opendap/DAPD1DatasetsDatabase">DAPD1DatasetsDatabase</a> and DAPD1Servlet projects (hosted here on GitHub). It's best to store them in the same root directory (e.g., called 'dataone') even though they are completely separate projects. For the DAPD1DatasetsDatabase, build it using <code>mvn clean install</code>. This will build the executable jar file used by the edit-db.sh bash shell script and install that in the local maven repository so it can be found by the DAPD1Servlet build. To build the DAPD1Servlet code, use <code>mvn clean package</code>. This will build a <code>war</code> file that can be installed in tomcat's <code>webapps</code> subdirectory. If there's a significant demand, we can make binaries available.</p>

<p>Note:</p>

<blockquote>
<p>I use Eclipse with the Maven plugin (<a href="http://download.eclipse.org/technology/m2e/releases">m2e</a>). Once the code is checked out using <code>git clone</code> on the command line, use <code>Eclipse:File:Import...</code> and choose <code>Git-&gt;Existing</code> local repository and select 
the <code>import as general &gt; project</code> option. In the project, Right click on the <code>pox.xml</code> file and choose <code>Run As...</code> to build. It would also work to check out the code directly into Eclipse.</p>
</blockquote>

<h3>
<a name="configure-and-test-the-server" class="anchor" href="#configure-and-test-the-server"><span class="octicon octicon-link"></span></a>Configure and Test the Server</h3>

<p>To install the DAP-DataOne server, you'll need Tomcat 7 (other servlet engines have not been tested; they might work, there's nothing I know about that is specific to Tomcat or Tomcat 7). Copy the <code>target/DAPD1Servlet.war</code> to Tomcat's <code>webapps</code> directory. Start Tomcat and then ten stop it. This little gyration will make a default 'opendap.properties' file that you can then edit (actually, you can simply start Tomcat and edit the file; the servlet will pick up the changes, but that doesn't always work as expected so I document the start-restart process). Look in <code>$CATALINA_HOME/webapps/DAPD1Servlet/WEB-INF/classes/</code> for that file and edit it as follows:</p>

<ul>
<li>
<code>org.opendap.d1.serviceName = http://&lt;host&gt;:&lt;port&gt;/DAPD1Servlet/d1</code> where <code>&lt;host&gt;</code> and <code>&lt;port&gt;</code> match where you are running Tomcat.</li>
<li>org.opendap.d1.DatabaseName = <code>&lt;path to the database&gt;</code>. In the DAPD1DatasetsDatabase project there is a test database named <code>test.db</code> that you can use for testing. Once you know the server's working, you'll need to build your own database and change this parameter value to reference it (see <a href="https://github.com/opendap/DAPD1DatasetsDatabase">DAPD1DatasetsDatabase</a>).</li>
<li>org.opendap.d1.LogDatabaseName = <code>&lt;path to access log database</code>. Give the full path to the access log database. If the database does not exist, it will be created (e.g., <code>/Users/jimg/src/dataone/DAPD1Servlet/log.db</code>).</li>
<li>org.opendap.d1.nodeName = <code>&lt;DAP server host name&gt;</code>, e.g., <code>test.opendap.org</code>. This is the DAP server that will be tested by the <code>ping</code> function. Note that the DAPD1DatasetsDatabase doesn't enforce that this is the only DAP server used, but it should be that case that the database holds only DAP datasets served by this host. For now, we're using the honor system ;-)</li>
<li>org.opendap.d1.nodeId = <code>&lt;URN for the node&gt;</code>, e.g., <code>urn:node:test_opendap_org</code>. This cannot use dots.</li>
<li>org.opendap.d1.contactSubject = <code>&lt;contact information</code>, e.g., <code>CN=James Gallagher,O=OPeNDAP,C=US</code>
</li>
<li>org.opendap.d1.nodeDescription = <code>&lt;Text description&gt;</code>, e.g., <code>This node contains test data.</code>
Once you have edited this file, make a copy of it someplace safe since the file will be overwritten if the <code>war</code> file is updated and you'd loose all your configuration information.</li>
</ul><p>Note:</p>

<blockquote>
<p>You may have to hack your Tomcat servlet engine a bit to get it to properly decode escaped characters in the path part of the &gt; URL. To do that, edit Tomcat's configuration file in <code>CATALINA_HOME/conf/catalina.properties</code>.
In Tomcat's 'catalina.properties' add:</p>

<ul>
<li><code>org.apache.tomcat.util.buf.UDecoder.ALLOW_ENCODED_SLASH=true</code></li>
<li><code>org.apache.catalina.connector.CoyoteAdapter.ALLOW_BACKSLASH=true</code></li>
</ul>
</blockquote>

<p>Once the config file(s) are edited, restart tomcat. If the <code>test.db</code> database is correctly referenced by the <code>org.opendap.d1.DatabaseName</code> option, the servlet should start without errors. Look in Tomcat's <code>catalina.out</code> log file to verify that is has started without error. If there are errors, edit the <code>logback.xml</code> file (<code>webapps/DAPD1Servlet/WEB-INF/classes/logback.xml</code>) and set the log level to <code>DEBUG</code> in the logger named "org.opendap.d1". Also note that the servlet writes log messages to a log file named 'opendap.log'.</p>

<p>Assuming Tomcat and the Servlet start without errors, try these URLs (I'll use <code>localhost:8080</code> for the host and port):</p>

<ul>
<li>Test the <code>ping</code> function: http://localhost:8080/DAPD1Servlet/d1/mn/v1/monitor/ping. This should return the time of the ping, but it may take a few seconds since it will test to see that your DAP server is really responding.</li>
<li>Look at the objects: http://localhost:8080/DAPD1Servlet/d1/mn/v1/object.</li>
<li>Look at the information for a given PID - this example uses a PID in the <code>test.db</code> database: http://localhost:8080/DAPD1Servlet/d1/mn/v1/object/test.opendap.org/dataone_sdo_1/opendap/hyrax/data/nc/fnoc1.nc</li>
<li>Look at that PID's metadata: http://localhost:8080/DAPD1Servlet/d1/mn/v1/meta/test.opendap.org/dataone_sdo_1/opendap/hyrax/data/nc/fnoc1.nc</li>
</ul><h3>
<a name="serving-your-own-data" class="anchor" href="#serving-your-own-data"><span class="octicon octicon-link"></span></a>Serving your own data</h3>

<p>See the information about adding and updating datasets in the database over in the <a href="http://opendap.github.io/DAPD1DatasetsDatabase">DAPD1DatasetsDatabase project</a>. Once this database has been built, copy it to a safe place and edit the <code>org.opendap.d1.DatabaseName</code> parameter so that it references it. Restart the servlet, check for errors and test using <code>ping</code> and some of your own datasets.</p>

<h2>
<a name="about-the-design-potential-optimizations-and-its-current-limitations" class="anchor" href="#about-the-design-potential-optimizations-and-its-current-limitations"><span class="octicon octicon-link"></span></a>About the design, potential optimizations and its current limitations</h2>

<p>This is the first attempt at a broker (using the term loosely) for DAP and DataONE and was written over about two months calendar time. The DataONE Java libraries along with an example servlet made the process go quite fast (about 5 weeks total development time). However, there are significant differences in some of the goals of the DAP and DataONE projects. Fundamentally, DAP is a <em>protocol</em> for data access and subsetting while DataONE is a <em>system</em> that provides a complete solution to a range of activities important to users of online data. This difference means that DataONE provides one or more solutions to a range of problems (data persistence, location, etc.) in addition to data access. In many ways that is what makes combining the two so interesting. With that in mind...</p>

<h3>
<a name="how-it-works" class="anchor" href="#how-it-works"><span class="octicon octicon-link"></span></a>How it works</h3>

<p><em>I'm going to assume you know how DataONE works, at least at a basic level.</em></p>

<p>The DAP-DataONE server uses two features of many DAP implementations to provide two of the three most important responses of the DataONE Tier 1 Member Node API: The Science Data Object (SDO) and Science Metadata Object (SMO). DAP servers often provide a way to access data packages in a netCDF3 file - regardless of how the data are originally stored. Thus the DAP-DataONE server is designed to always return the SDO as a netCDF3 file. The original data might have been stored in a RDB, a HDF4 File, etc., but the return format from the DAP-DataONE server will always be as a netCDF3 file. The SMO - a metadata object that matches the SDO - is built using many DAP server's ability to build ISO-19115 documents that describe any given dataset. </p>

<p>The DAP URL to the dataset is used to build the URLs that are used to access the SDO and SMO from the DAP server. For each dataset that the DAP server holds, there is one base URL and derived from that base URL there is one URL that will return a netCDF3 file that holds all of its data (the SDO) and one URL that will return the ISO-19115 document (the SMO).</p>

<p>Note that DataONE clients refer to the SDO and SMO using Persistent Identifiers (PIDs) and not URLs per se. These PIDs are passed to a server that implements the DataONE API as parameters to a URL. The DAP-DataONE server stores the PIDs in a database and looks up the PID passed to it to determine the URL to use in accessing the requested SDO or SMO. The third object that a DataONE Member Node may return is a Object Reuse and Excahnge (<a href="http://www.openarchives.org/ore/documents/">ORE</a>) document. This document is built using the SDO and SMO PIDs (not the DAP URLs, but the DataONE PIDs that refer to those URLs). The ORE document is stored in the DAP-DataONE server's database</p>

<p>In addition, DataONE requires other information about any given dataset. For each of the SDO, SMO and ORE responses, DataONE specifies a set of 'system metadata' that must also be made available by a DataONE server. This information includes the PID that is used to access the response, the size and checksum of the response as well as other metadata. The DAP-DataONE server uses a relational database to store this information.</p>

<p>The DAP-DataONE server uses SQLite (although it will be trivial to substitute a different database engine like MySQL) to store the metadata, PIDs, and other information including the ORE documents. This information is accessed and used to build every response <em>except</em> the SDO and SMO responses. The SDO and SMO responses are read from the DAP server, not the relational database. The <a href="http://opendap.github.io/DAPD1DatasetsDatabase">DAPD1DatasetsDatabase</a> project web page contains information about the tables in the current implementation of the datasets database. </p>

<p>The DAP-DataONE server also uses the RDB to store access information. Information about every SDO, SMO and ORE request is stored in a table and can be queried using the DataONE 'log' function.</p>

<h2>
<a name="optimizations-and-improvements" class="anchor" href="#optimizations-and-improvements"><span class="octicon octicon-link"></span></a>Optimizations and Improvements</h2>

<p>From the preceding description, it should be clear that one optimization of the server would be to cache the ISO-19115 metadata documents, either in the database or using a separate cache tool like the Java Caching System (JCS). This would speed up the response for these objects. Similarly, if sufficient memory is available for a server, caching the SDO would also boost performance, although this would likely be a real cache in the sense that old items would be pushed out to make room for newer or more frequently requested things. The current 'caching' of the ORE documents stores all of them permanently in the database.</p>

<p>The server could benefit from more generic optimizations such as pooling database connections and object reuse by the servlet. These kinds of optimizations will benefit installations with high usage (where 'high' is, or course, a relative term) but do not affect the overall functionality of the server in a conceptual sense.</p>

<p>There are some quirks to the server's design that could be addressed, and while not really optimizations, doing these things would improve its ease of use. First, the servlet and the database are loosely coupled, and while normally that's a good thing, in this case it can lead to some odd behavior. In particular, the server has a single DAP server named in the configuration file with the implication that all data are served from that one site. However, that does not have to be the case because there's no limitation on the number of different sites can be in the database (i.e., there's no way to ensure the database and the configuration file agree). In fact, the database has no notion of sites at all; it simply holds URLs without considering where the data will be read from. The 'ping' function uses the 'DAP server' named in the configuration parameter, so success of 'ping' means only that the one DAP server named in the configuration file is working, not that all of the servers referenced in the URLs in the database are up.</p>

<p>DAP servers that return ISO-19115 documents do not always return <em>useful</em> ISO-19115 documents because sometimes the underlying datasets lack information needed by the ISO standard. In the case where required information is missing, it is simply marked as 'null.' A very useful improvement to this server would be an editing tool that would enable a data provider to easily supplant the metadata in the automatically generated document. This can be done now using NCML or an Ancillary DAS on the DAP server, but it requires that the person configuring the DAP-DataONE server also have access to the DAP server. If this metadata editing and augmentation ability were combined with local metadata document caching, two issues - performance and usefulness - could be addressed at once.</p>

<p>The process of adding datasets is somewhat tedious. If the DAP-DataONE server could automate this, possibly in combination with a web interface, it would be much easier to manage a large number of datasets. As it stands, the database is edited using a command-line tool that is somewhat limited in its abilities (see <a href="http://opendap.github.io/DAPD1DatasetsDatabase">DAPD1DatasetsDatabase</a> for more information.</p>

<h2>
<a name="limitations" class="anchor" href="#limitations"><span class="octicon octicon-link"></span></a>Limitations</h2>

<p>DataONE, as was said earlier, is a complete data system that addresses a number of issues in the data management life-cycle. DAP is a protocol used to access data. The strengths of DAP are its ability to hide storage format and to provide server processing functions and subsetting operations. However, the latter two of those three features are accessed using a web services API, which is currently out of scope for DataONE. There is a real likelihood that the version 2 DataONE Member Node protocol will include support for web services at the same level as the version 1 protocol includes support for file formats but, that is currently not the case. This means that SDO access by the DAP-DataONE server is limited to either entire DAP datasets or preconfigured subsets of datasets. For datasets served by DAP that are aggregations of thousands of large files (e.g., satellite-derived time series data), it is simply not practical to access them using DataONE version 1. It <em>is</em> possible to configure 'useful subsets' of those and make them available - because the DAP URLs for subsets are distinct from those that reference the entire dataset - but those subsets must be hardwired by the person who configures the DAP-DataONE server. This limitation is fundamental to the designs of DAP and DataONE, not the DAP-DataONE server.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/jgallagher59701">jgallagher59701</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>